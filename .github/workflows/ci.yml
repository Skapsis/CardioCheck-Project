name: ğŸš€ CardioCheck CI/CD

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]

jobs:
  # ğŸŒ Test Web Version
  test-web:
    name: ğŸŒ Web App Tests
    runs-on: ubuntu-latest
    steps:
      - name: ğŸ“¥ Checkout Code
        uses: actions/checkout@v4

      - name: ğŸ“¦ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'

      - name: ğŸ“š Install Dependencies
        run: npm ci

      - name: ğŸ§ª Run Tests (if exist)
        run: npm test --if-present
        continue-on-error: true

      - name: ğŸ”¨ Build Web App
        run: npm run build

      - name: ğŸ“Š Check Bundle Size
        run: |
          echo "ğŸ“¦ Build completed successfully!"
          du -sh dist/
          ls -la dist/

  # ğŸ“± Test Mobile Version  
  test-mobile:
    name: ğŸ“± Mobile App Tests
    runs-on: ubuntu-latest
    steps:
      - name: ğŸ“¥ Checkout Code
        uses: actions/checkout@v4

      - name: ğŸ“¦ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'
          cache-dependency-path: mobile/package-lock.json

      - name: ğŸ“± Install Mobile Dependencies
        working-directory: ./mobile
        run: npm ci

      - name: ğŸ§ª Validate React Native Code
        working-directory: ./mobile
        run: |
          echo "ğŸ” Checking for web dependencies in mobile..."
          if grep -r "react-bootstrap\|antd\|@mui\|lucide-react" . --exclude-dir=node_modules; then
            echo "âŒ Found web-only dependencies in mobile code!"
            exit 1
          else
            echo "âœ… No web dependencies found in mobile code"
          fi

      - name: ğŸ“‹ Check Native Components Only
        working-directory: ./mobile
        run: |
          echo "ğŸ” Validating React Native components..."
          if grep -r "import.*from 'react'" App.js | grep -v "react-native"; then
            echo "âš ï¸ Warning: Check React imports in mobile"
          fi
          echo "âœ… Mobile validation completed"

  # ğŸ” Code Quality
  code-quality:
    name: ğŸ” Code Quality
    runs-on: ubuntu-latest
    steps:
      - name: ğŸ“¥ Checkout Code
        uses: actions/checkout@v4

      - name: ğŸ“¦ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'

      - name: ğŸ§® Validate ML Constants
        run: |
          echo "ğŸ§  Checking ML model constants..."
          
          # Check if MODEL_PARAMS exists in both versions
          if grep -r "MODEL_PARAMS" src/ && grep -r "MODEL_PARAMS" mobile/; then
            echo "âœ… ML constants found in both web and mobile"
          else
            echo "âŒ ML constants missing in one version"
            exit 1
          fi
          
          # Validate intercept value
          if grep -r "0.13159523820583108" src/ mobile/; then
            echo "âœ… Correct intercept value found"
          else
            echo "âŒ Intercept value modified!"
            exit 1
          fi

      - name: ğŸ“± Mobile Compatibility Check
        run: |
          echo "ğŸ“± Checking mobile compatibility..."
          
          # Ensure no HTML elements in mobile
          if grep -r "<div>\|<button>\|<input>" mobile/ --exclude-dir=node_modules; then
            echo "âŒ HTML elements found in mobile code!"
            exit 1
          fi
          
          # Check for React Native imports
          if grep -r "from 'react-native'" mobile/App.js; then
            echo "âœ… React Native imports found"
          else
            echo "âŒ Missing React Native imports"
            exit 1
          fi

  # ğŸ“Š Security & Dependencies
  security:
    name: ğŸ”’ Security Scan
    runs-on: ubuntu-latest
    steps:
      - name: ğŸ“¥ Checkout Code
        uses: actions/checkout@v4

      - name: ğŸ“¦ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'

      - name: ğŸ” Audit Web Dependencies
        run: |
          npm audit --audit-level=moderate || true
          echo "âœ… Web audit completed"

      - name: ğŸ” Audit Mobile Dependencies
        working-directory: ./mobile
        run: |
          npm audit --audit-level=moderate || true
          echo "âœ… Mobile audit completed"

  # ğŸ“‹ Documentation Check
  docs:
    name: ğŸ“š Documentation
    runs-on: ubuntu-latest
    steps:
      - name: ğŸ“¥ Checkout Code
        uses: actions/checkout@v4

      - name: ğŸ“‹ Check README Files
        run: |
          echo "ğŸ“š Validating documentation..."
          
          # Check main README
          if [ -f "README.md" ]; then
            echo "âœ… Main README.md exists"
            if grep -q "CardioCheck" README.md; then
              echo "âœ… README contains project name"
            fi
          else
            echo "âŒ Main README.md missing"
            exit 1
          fi
          
          # Check mobile README
          if [ -f "mobile/README.md" ]; then
            echo "âœ… Mobile README.md exists"
          else
            echo "âŒ Mobile README.md missing"
            exit 1
          fi

      - name: ğŸ”— Check Critical Files
        run: |
          echo "ğŸ“‹ Checking critical files..."
          
          files=("LICENSE" "package.json" "mobile/package.json" "mobile/app.json")
          for file in "${files[@]}"; do
            if [ -f "$file" ]; then
              echo "âœ… $file exists"
            else
              echo "âŒ $file missing"
              exit 1
            fi
          done

  # ğŸš€ Deploy Status
  deploy-ready:
    name: ğŸš€ Deploy Ready
    needs: [test-web, test-mobile, code-quality, security, docs]
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main'
    steps:
      - name: ğŸ‰ All Checks Passed
        run: |
          echo "ğŸ‰ All checks passed successfully!"
          echo "âœ… Web version: Ready"
          echo "âœ… Mobile version: Ready" 
          echo "âœ… Code quality: Passed"
          echo "âœ… Security: Scanned"
          echo "âœ… Documentation: Complete"
          echo ""
          echo "ğŸš€ CardioCheck is ready for deployment!"